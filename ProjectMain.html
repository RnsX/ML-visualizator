<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine learning visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.0.0/math.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js" rel="script"></script>
</head>
<body>
    <h2>Test results</h2>
    <div id="cont"></div>
    <hr/>
    
    <h2>Cost function (during iterations)</h2>
    <div id="costFunct"></div>   
    <hr/>
    
    <button onclick="nerualNetworkScore()">train model</button>
    <button onclick="runTest()">runTest</button>
    <button onclick="renderResults()">draw scored set</button>
    <button onclick="renderCostFunction()">draw cost function</button>
</body>
</html>

<!-- Drawing and graphing -->
<script>
    const renderCostFunction = () => {
        var container = document.getElementById("costFunct");
        var items = [];
        let iterNum = 1;

        storedCostFunction.forEach(costItem => {
            items.push(
                {
                    x: iterNum, y: costItem
                }
            );
            iterNum++;
        });

        var dataset = new vis.DataSet(items);
        var options = {
            start: 0,
            end: iterations
        };

        var graph2d = new vis.Graph2d(container, dataset, options);
    }

    const renderResults = () => {
        var predicted = [];

        for (let i = 0; i < testResults.length; i++) {
            predicted.push(
                {
                    x: x_test[i],
                    y: y_test[i],
                    group: storedResults[i] >= 0.3 ? "red" : "blue"
                }
            )            
        };

        console.log(predicted);

        var container = document.getElementById("cont");
        var dataset = new vis.DataSet(predicted);
        var options = {
            sort: false,
            sampling: false,
            style: 'points',
            dataAxis: {
                left: {
                    range: {
                        min:0, max:50
                    }
                }
            },
            drawPoints: {
                enabled: true,
                size: 6,
                style: 'circle'
            },
            defaultGroup: 'Scatterplot',
            height: '300px'
        };

        var garph2d = new vis.Graph2d(container, dataset, options);
    }
</script>


<!-- Machine learning -->
<script>
    let x = [];
    let y = [];
    let value = [];

    let x_test = [];
    let y_test = [];
    let testResults = [];
    
    let storedResults = [];
    let storedTheta = [];
    let storedCostFunction = [];


    let iterations = 300;
    let alpha = 0.5;

    const nerualNetworkScore = () => {
        generateSampleData();

        x = normalizeMaxMin(x);
        y = normalizeMaxMin(y);
        let theta = [1,1];
        let dataM = math.matrix([x,y]);

        let costFunction = [];
        let iterationHistory = [];


        for (let idx = 0; idx < iterations; idx++) {

            let thetaX = math.multiply(math.transpose(theta), dataM); // theta' * X
            let h = activationFunct(thetaX);

            let result_one = math.multiply(
                dataM,
                math.subtract(h,value)
            );

            theta = math.subtract(
                theta,
                (
                    math.multiply(
                        (alpha/(x.length)),
                        result_one
                    )
                )
            );
            
            let cost_one = math.multiply(
                math.transpose(math.multiply(-1, value)),
                math.log(h)
            );

            let cost_two = math.multiply
            (
                math.transpose(
                    math.subtract(
                        1,
                        math.multiply(-1,value)
                    )
                ),
                math.log(math.subtract(1,h))
            );

            costFunction.push(
                math.multiply(
                    math.divide(
                        1,
                        x.length
                    ),
                    math.subtract(
                        cost_one,
                        cost_two
                    ),
                )-1
            );
            

            let thetaXdata = math.multiply(math.transpose(theta), dataM); // theta' * X
            let history_result = activationFunct(thetaXdata);
            iterationHistory.push(history_result);
        }
        
        let thetaXdata = math.multiply(math.transpose(theta), dataM); // theta' * X
        let final_results = activationFunct(thetaXdata);
        // console.log("final classifications: ", final_results);
        // console.log("cost function: ", costFunction);
        // console.log("iteration history: ", iterationHistory);
        // console.log(JSON.stringify(iterationHistory));
        console.log("done ml!");
        storedResults = final_results;
        storedTheta = theta;
        storedCostFunction = costFunction;
        alert("Training done!");
    }

    const activationFunct = (arrayInput) => {
        let output = [];
        arrayInput.forEach(x => {
            output.push((1)/(1+(math.exp(-x))));
        });
        return output;
    }
    const normalizeMaxMin = (inputArray) => {
        let max = Math.max(...inputArray);
        let min = Math.min(...inputArray);
        let outputArray = [];

        inputArray.forEach(item => {
            outputArray.push(((item - min) / (max - min)));
        });

        return outputArray;   
    }
    const dotProduct = (a, b) => 
    {
        let output = a.map((x, i) => a[i] * b[i]).reduce((m, n) => m + n);
        return output;
    }
    const generateSampleData = () => {
        for (let i = 0; i < 20; i++) {
            x.push(getRandomInt(5,20));
            y.push(getRandomInt(5,20));
            value.push(1);
        }
        for (let i = 0; i < 20; i++) {
            x.push(getRandomInt(35,45));
            y.push(getRandomInt(40,50));
            value.push(0);
        }
    }

    const runTest = () => {
        generateTestData();
        let dataM = math.matrix([x_test,y_test]);
        let thetaXdata = math.multiply(math.transpose(storedTheta), dataM); // theta' * X
        let final_results = activationFunct(thetaXdata);
        testResults = final_results;
        alert("Test scoring one!");
    }

    const generateTestData = () => {
        for (let i = 0; i < 20; i++) {
            x_test.push(getRandomInt(5,30));
            y_test.push(getRandomInt(5,30));
            value.push(1);
        }
        for (let i = 0; i < 20; i++) {
            x_test.push(getRandomInt(25,45));
            y_test.push(getRandomInt(30,50));
            value.push(0);
        }
    }

    function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
</script>